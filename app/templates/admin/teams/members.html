{% extends "base.html" %}

{% block title %}成员管理 - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Team 成员管理</h2>
</div>

<!-- Team 信息 -->
<div class="content-section">
    <h3>Team 信息</h3>
    <div class="team-info-grid">
        <div class="info-item">
            <span class="info-label">邮箱:</span>
            <span class="info-value">{{ team.email }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Team 名称:</span>
            <span class="info-value">{{ team.team_name or '-' }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">成员数:</span>
            <span class="info-value">{{ team.current_members }}/{{ team.max_members }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">订阅计划:</span>
            <span class="info-value">{{ team.subscription_plan or '-' }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">到期时间:</span>
            <span class="info-value">{{ team.expires_at|format_datetime }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">状态:</span>
            <span class="status-badge status-{{ team.status }}">
                {% if team.status == 'active' %}
                可用
                {% elif team.status == 'full' %}
                已满
                {% elif team.status == 'expired' %}
                已过期
                {% else %}
                异常
                {% endif %}
            </span>
        </div>
    </div>
</div>

<!-- 成员列表 -->
<div class="content-section">
    <div class="section-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <h3>成员列表 ({{ members|length }})</h3>
            <span class="badge badge-info">{{ team.current_members }}/{{ team.max_members }}</span>
        </div>
        <div class="action-buttons">
            <button onclick="showModal('addMemberModal')" class="btn btn-primary" {% if team.current_members>=
                team.max_members %}disabled title="席位已满"{% endif %}>
                <i data-lucide="user-plus"></i> 添加成员
            </button>
            <button onclick="refreshMembers()" class="btn btn-secondary">
                <i data-lucide="refresh-cw"></i> 刷新
            </button>
        </div>
    </div>

    {% if members %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>邮箱</th>
                    <th>名称</th>
                    <th>角色</th>
                    <th>加入时间</th>
                    <th style="text-align: right;">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for member in members %}
                <tr>
                    <td>{{ member.email }}</td>
                    <td>{{ member.name or '-' }}</td>
                    <td>
                        <span class="role-badge role-{{ member.role }}">
                            {% if member.role == 'account-owner' %}
                            所有者
                            {% else %}
                            成员
                            {% endif %}
                        </span>
                    </td>
                    <td>{{ member.added_at|format_datetime }}</td>
                    <td style="text-align: right;">
                        {% if member.role != 'account-owner' %}
                        <button onclick="deleteMember('{{ team.id }}', '{{ member.user_id }}', '{{ member.email }}')"
                            class="btn btn-sm btn-danger">
                            删除
                        </button>
                        {% else %}
                        <span class="text-muted">不可删除</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>暂无成员数据</p>
    </div>
    {% endif %}
</div>

<div style="margin-top: 2rem;">
    <a href="/admin" class="btn btn-secondary">返回控制台</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 在页面加载后初始化图标
    document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide) lucide.createIcons();
    });

    function refreshMembers() {
        location.reload();
    }

    // 注入当前 teamId 供全局使用
    window.currentTeamId = "{{ team.id }}";
</script>
{% endblock %}