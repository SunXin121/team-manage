{% extends "base.html" %}

{% block title %}系统设置 - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>系统设置</h2>
</div>

<div style="display: grid; gap: 20px;">
    <!-- 代理设置 -->
    <div class="content-section">
        <div class="section-header" style="border-bottom: none; padding-bottom: 0;">
            <h3 style="font-size: 1rem; font-weight: 600;">
                <i data-lucide="globe" style="width: 18px; height: 18px; margin-right: 6px; vertical-align: -3px;"></i>
                代理设置
            </h3>
        </div>
        <form id="proxyForm" onsubmit="handleProxySubmit(event)" style="padding: 0 20px 20px 20px;">
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="proxyEnabled" name="enabled"
                        {{ 'checked' if proxy_enabled else '' }}
                        style="width: 18px; height: 18px; accent-color: var(--apple-blue);"
                        onchange="toggleProxyInput()">
                    <span>启用代理</span>
                </label>
            </div>
            <div class="form-group" id="proxyInputGroup" style="{{ '' if proxy_enabled else 'display: none;' }}">
                <label>代理地址</label>
                <input type="text" id="proxyAddress" name="proxy" class="form-control"
                    value="{{ proxy or '' }}" placeholder="http://host:port 或 socks5://host:port">
                <span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; display: block;">
                    支持 http、https、socks5、socks5h 协议
                </span>
            </div>
            <button type="submit" class="btn btn-primary" style="width: auto; padding: 8px 28px;">保存</button>
        </form>
    </div>

    <!-- 密码修改 -->
    <div class="content-section">
        <div class="section-header" style="border-bottom: none; padding-bottom: 0;">
            <h3 style="font-size: 1rem; font-weight: 600;">
                <i data-lucide="lock" style="width: 18px; height: 18px; margin-right: 6px; vertical-align: -3px;"></i>
                修改密码
            </h3>
        </div>
        <form id="passwordForm" onsubmit="handlePasswordSubmit(event)" style="padding: 0 20px 20px 20px;">
            <div class="form-group">
                <label>当前密码</label>
                <input type="password" id="currentPassword" name="current_password" class="form-control" required>
            </div>
            <div class="form-group">
                <label>新密码</label>
                <input type="password" id="newPassword" name="new_password" class="form-control" required
                    minlength="6">
            </div>
            <div class="form-group">
                <label>确认新密码</label>
                <input type="password" id="confirmPassword" name="confirm_password" class="form-control" required
                    minlength="6">
            </div>
            <button type="submit" class="btn btn-primary" style="width: auto; padding: 8px 28px;">修改密码</button>
        </form>
    </div>

    <!-- 日志级别 -->
    <div class="content-section">
        <div class="section-header" style="border-bottom: none; padding-bottom: 0;">
            <h3 style="font-size: 1rem; font-weight: 600;">
                <i data-lucide="file-text" style="width: 18px; height: 18px; margin-right: 6px; vertical-align: -3px;"></i>
                日志级别
            </h3>
        </div>
        <form id="logLevelForm" onsubmit="handleLogLevelSubmit(event)" style="padding: 0 20px 20px 20px;">
            <div class="form-group">
                <label>日志级别</label>
                <select id="logLevel" name="level" class="form-control">
                    <option value="DEBUG" {{ 'selected' if log_level == 'DEBUG' else '' }}>DEBUG</option>
                    <option value="INFO" {{ 'selected' if log_level == 'INFO' else '' }}>INFO</option>
                    <option value="WARNING" {{ 'selected' if log_level == 'WARNING' else '' }}>WARNING</option>
                    <option value="ERROR" {{ 'selected' if log_level == 'ERROR' else '' }}>ERROR</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="width: auto; padding: 8px 28px;">保存</button>
        </form>
    </div>

    <!-- 支付设置 -->
    <div class="content-section">
        <div class="section-header" style="border-bottom: none; padding-bottom: 0;">
            <h3 style="font-size: 1rem; font-weight: 600;">
                <i data-lucide="credit-card" style="width: 18px; height: 18px; margin-right: 6px; vertical-align: -3px;"></i>
                支付设置
            </h3>
        </div>
        <div style="padding: 0 20px 20px 20px;">
            <!-- 支付方式开关 -->
            <div style="display: flex; gap: 24px; margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="alipayEnabled" {{ 'checked' if alipay_enabled else '' }}
                        style="width: 18px; height: 18px; accent-color: var(--apple-blue);"
                        onchange="handlePaymentMethodsChange()">
                    <span>支付宝</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="wxpayEnabled" {{ 'checked' if wxpay_enabled else '' }}
                        style="width: 18px; height: 18px; accent-color: var(--apple-blue);"
                        onchange="handlePaymentMethodsChange()">
                    <span>微信支付</span>
                </label>
            </div>

            <!-- 码支付配置 -->
            <form id="mapayForm" onsubmit="handleMapaySubmit(event)">
                <div class="search-form-grid">
                    <div class="form-group">
                        <label>商户 ID</label>
                        <input type="text" id="mapayId" name="mapay_id" class="form-control"
                            value="{{ mapay_id or '' }}" placeholder="码支付商户 ID">
                    </div>
                    <div class="form-group">
                        <label>通信密钥</label>
                        <input type="password" id="mapayKey" name="mapay_key" class="form-control"
                            value="{{ mapay_key or '' }}" placeholder="码支付通信密钥">
                    </div>
                    <div class="form-group">
                        <label>API 地址</label>
                        <input type="text" id="mapayUrl" name="mapay_url" class="form-control"
                            value="{{ mapay_url or 'https://pay.yueuo.cn' }}" placeholder="https://pay.yueuo.cn">
                    </div>
                    <div class="form-group">
                        <label>网站域名</label>
                        <input type="text" id="mapayDomain" name="mapay_domain" class="form-control"
                            value="{{ mapay_domain or '' }}" placeholder="例如: https://yourdomain.com">
                    </div>
                    <div class="form-group">
                        <label>支付金额</label>
                        <input type="text" id="mapayPrice" name="mapay_price" class="form-control"
                            value="{{ mapay_price or '19.9' }}" placeholder="19.9">
                    </div>
                    <div class="form-group">
                        <label>商品名称</label>
                        <input type="text" id="mapayProductName" name="mapay_product_name" class="form-control"
                            value="{{ mapay_product_name or 'GPT Team 会员' }}" placeholder="GPT Team 会员">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"
                    style="width: auto; padding: 8px 28px; margin-top: 4px;">保存支付配置</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleProxyInput() {
        const enabled = document.getElementById('proxyEnabled').checked;
        document.getElementById('proxyInputGroup').style.display = enabled ? '' : 'none';
    }

    async function handleProxySubmit(event) {
        event.preventDefault();
        const enabled = document.getElementById('proxyEnabled').checked;
        const proxy = document.getElementById('proxyAddress').value.trim();

        try {
            const response = await fetch('/admin/settings/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled, proxy })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('代理配置已保存', 'success');
            } else {
                showToast(result.error || '保存失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    async function handlePasswordSubmit(event) {
        event.preventDefault();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            showToast('两次输入的密码不一致', 'error');
            return;
        }

        if (newPassword.length < 6) {
            showToast('密码长度至少 6 位', 'error');
            return;
        }

        try {
            const response = await fetch('/auth/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('密码修改成功', 'success');
                document.getElementById('passwordForm').reset();
            } else {
                showToast(result.error || '修改失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    async function handleLogLevelSubmit(event) {
        event.preventDefault();
        const level = document.getElementById('logLevel').value;

        try {
            const response = await fetch('/admin/settings/log-level', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ level })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('日志级别已保存', 'success');
            } else {
                showToast(result.error || '保存失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    async function handleMapaySubmit(event) {
        event.preventDefault();

        try {
            const response = await fetch('/admin/settings/mapay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mapay_id: document.getElementById('mapayId').value.trim(),
                    mapay_key: document.getElementById('mapayKey').value.trim(),
                    mapay_url: document.getElementById('mapayUrl').value.trim(),
                    mapay_domain: document.getElementById('mapayDomain').value.trim(),
                    mapay_price: document.getElementById('mapayPrice').value.trim(),
                    mapay_product_name: document.getElementById('mapayProductName').value.trim()
                })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('支付配置已保存', 'success');
            } else {
                showToast(result.error || '保存失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    async function handlePaymentMethodsChange() {
        const alipayEnabled = document.getElementById('alipayEnabled').checked;
        const wxpayEnabled = document.getElementById('wxpayEnabled').checked;

        try {
            const response = await fetch('/admin/settings/payment-methods', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    alipay_enabled: alipayEnabled,
                    wxpay_enabled: wxpayEnabled
                })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('支付方式已更新', 'success');
            } else {
                showToast(result.error || '保存失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }
</script>
{% endblock %}
