{% extends "base.html" %}

{% block title %}兑换码管理 - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>兑换码管理</h2>
</div>

<!-- 统计卡片 -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-icon"><i data-lucide="ticket" style="width: 20px; height: 20px;"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">兑换码总数</div>
        </div>
    </div>
    <div class="stat-card stat-success">
        <div class="stat-icon"><i data-lucide="check-circle" style="width: 20px; height: 20px;"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.unused }}</div>
            <div class="stat-label">未使用</div>
        </div>
    </div>
    <div class="stat-card stat-info">
        <div class="stat-icon"><i data-lucide="clipboard-check" style="width: 20px; height: 20px;"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.used }}</div>
            <div class="stat-label">已使用</div>
        </div>
    </div>
    <div class="stat-card stat-danger">
        <div class="stat-icon"><i data-lucide="clock" style="width: 20px; height: 20px;"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.expired }}</div>
            <div class="stat-label">已过期</div>
        </div>
    </div>
</div>

<!-- 操作栏 -->
<div class="content-section">
    <div class="section-header">
        <div class="header-group">
            <div class="filter-tabs">
                <button onclick="filterByStatus('all')" class="filter-tab active" id="filter-all">全部</button>
                <button onclick="filterByStatus('unused')" class="filter-tab" id="filter-unused">未使用</button>
                <button onclick="filterByStatus('used')" class="filter-tab" id="filter-used">已使用</button>
                <button onclick="filterByStatus('expired')" class="filter-tab" id="filter-expired">已过期</button>
            </div>

            <form action="/admin/codes" method="get" class="search-form">
                <div class="input-group-clean">
                    <i data-lucide="search" style="width: 14px; height: 14px;"></i>
                    <input type="text" name="search" value="{{ search or '' }}" placeholder="搜索兑换码..."
                        style="width: 160px;">
                    {% if search %}
                    <a href="/admin/codes" title="清除搜索" style="display: flex; color: var(--text-dim);">
                        <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <div class="header-group">
            <button onclick="showModal('generateCodeModal')" class="btn btn-primary">
                <i data-lucide="plus" style="width: 16px; height: 16px;"></i> 生成兑换码
            </button>
            <button onclick="exportCodes()" class="btn btn-secondary">
                <i data-lucide="download" style="width: 16px; height: 16px;"></i> 导出
            </button>
        </div>
    </div>

    {% if codes %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"
                            style="width: 16px; height: 16px; accent-color: var(--apple-blue);">
                    </th>
                    <th>兑换码</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>过期时间</th>
                    <th>使用者邮箱</th>
                    <th>使用时间</th>
                    <th>质保</th>
                    <th>质保时长</th>
                    <th style="text-align: right;">操作</th>
                </tr>
            </thead>
            <tbody id="codesTableBody">
                {% for code in codes %}
                <tr data-status="{{ code.status }}">
                    <td>
                        <input type="checkbox" class="code-checkbox" value="{{ code.code }}"
                            onchange="updateSelectionCount()" style="width: 16px; height: 16px; accent-color: var(--apple-blue);">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <code>{{ code.code }}</code>
                        </div>
                    </td>
                    <td>
                        {% if code.status == 'unused' %}
                        <span class="status-badge status-active">未使用</span>
                        {% elif code.status == 'used' %}
                        <span class="status-badge status-full">已使用</span>
                        {% elif code.status == 'warranty_active' %}
                        <span class="status-badge status-info">质保中</span>
                        {% elif code.status == 'expired' %}
                        <span class="status-badge status-error">已过期</span>
                        {% endif %}
                    </td>
                    <td>{{ code.created_at }}</td>
                    <td>{{ code.expires_at if code.expires_at else '永久有效' }}</td>
                    <td>{{ code.used_by_email if code.used_by_email else '-' }}</td>
                    <td>{{ code.used_at if code.used_at else '-' }}</td>
                    <td>
                        {% if code.has_warranty %}
                        <span class="status-badge status-info">是</span>
                        {% else %}
                        <span class="status-badge" style="background: rgba(0,0,0,0.04); color: var(--text-muted);">否</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if code.has_warranty %}
                        <span style="font-size: 0.875rem;">{{ code.warranty_days }} 天</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        <div class="action-buttons" style="justify-content: flex-end;">
                            <button onclick="copyCode('{{ code.code }}')"
                                class="btn btn-sm btn-icon btn-minimal btn-secondary" title="复制">
                                <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button
                                onclick="editCode('{{ code.code }}', {{ 'true' if code.has_warranty else 'false' }}, {{ code.warranty_days or 30 }})"
                                class="btn btn-sm btn-icon btn-minimal btn-info" title="编辑">
                                <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i>
                            </button>
                            {% if code.status == 'unused' %}
                            <button onclick="deleteCode('{{ code.code }}')"
                                class="btn btn-sm btn-icon btn-minimal btn-danger" title="删除">
                                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 批量操作栏 -->
    <div id="bulkActionBar" class="bulk-action-bar" style="display: none;">
        <div class="bulk-info">
            已选择 <span id="selectedCount">0</span> 个兑换码
        </div>
        <div class="bulk-actions">
            <button onclick="showBulkEditModal()" class="btn btn-primary" style="width: auto;">
                批量修改质保
            </button>
            <button onclick="deselectAll()" class="btn btn-secondary" style="width: auto;">取消全选</button>
        </div>
    </div>

    <!-- 分页 -->
    {% if pagination and pagination.total_pages > 1 %}
    <div class="pagination">
        {% set search_param = '&search=' + search if search else '' %}
        {% if pagination.current_page > 1 %}
        <a href="?page=1{{ search_param }}" class="btn btn-sm btn-secondary">首页</a>
        <a href="?page={{ pagination.current_page - 1 }}{{ search_param }}" class="btn btn-sm btn-secondary">
            <i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i>
        </a>
        {% endif %}
        <span class="pagination-info">第 {{ pagination.current_page }} / {{ pagination.total_pages }} 页</span>
        {% if pagination.current_page < pagination.total_pages %}
        <a href="?page={{ pagination.current_page + 1 }}{{ search_param }}" class="btn btn-sm btn-secondary">
            <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
        </a>
        <a href="?page={{ pagination.total_pages }}{{ search_param }}" class="btn btn-sm btn-secondary">末页</a>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <i data-lucide="package-open" style="width: 48px; height: 48px; opacity: 0.15;"></i>
        <p style="margin-top: 12px;">暂无兑换码数据</p>
        <button onclick="showModal('generateCodeModal')" class="btn btn-primary" style="width: auto; padding: 8px 24px;">立即生成</button>
    </div>
    {% endif %}
</div>

<!-- 批量编辑兑换码模态框 -->
<div id="bulkEditCodeModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>批量修改质保</h3>
            <button class="modal-close" onclick="hideModal('bulkEditCodeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info" style="margin-bottom: 16px;">
                您正在批量修改 <strong id="bulk-selected-count-display">0</strong> 个兑换码的质保信息。
            </div>
            <form id="bulkEditCodeForm" onsubmit="handleBulkEditCode(event)">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 8px;">
                        <input type="checkbox" id="bulk-edit-has-warranty" name="hasWarranty"
                            style="width: 18px; height: 18px; accent-color: var(--apple-blue);"
                            onchange="toggleWarrantyDays(this, 'bulk-edit-warranty-days-group')">
                        <span>质保兑换码 (可重复使用)</span>
                    </label>
                </div>
                <div class="form-group" id="bulk-edit-warranty-days-group" style="display: none;">
                    <label>质保时长 (天) *</label>
                    <input type="number" id="bulk-edit-warranty-days" name="warrantyDays" class="form-control"
                        value="30" min="1" max="3650">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 8px;">保存修改</button>
            </form>
        </div>
    </div>
</div>

<!-- 编辑兑换码模态框 -->
<div id="editCodeModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>编辑兑换码</h3>
            <button class="modal-close" onclick="hideModal('editCodeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editCodeForm" onsubmit="handleEditCode(event)">
                <input type="hidden" id="edit-code" name="code">
                <div class="form-group">
                    <label>兑换码</label>
                    <input type="text" id="edit-code-display" class="form-control" readonly
                        style="background: var(--apple-gray);">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 8px;">
                        <input type="checkbox" id="edit-has-warranty" name="hasWarranty"
                            style="width: 18px; height: 18px; accent-color: var(--apple-blue);"
                            onchange="toggleWarrantyDays(this, 'edit-warranty-days-group')">
                        <span>质保兑换码 (可重复使用)</span>
                    </label>
                </div>
                <div class="form-group" id="edit-warranty-days-group" style="display: none;">
                    <label>质保时长 (天) *</label>
                    <input type="number" id="edit-warranty-days" name="warrantyDays" class="form-control" value="30"
                        min="1" max="3650">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 8px;">保存修改</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .bulk-action-bar {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-surface);
        padding: 12px 24px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: 24px;
        z-index: 100;
        border: none;
    }

    .bulk-info {
        font-weight: 500;
        color: var(--text-main);
        font-size: 0.875rem;
    }

    .bulk-actions {
        display: flex;
        gap: 8px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('.code-checkbox');
        checkboxes.forEach(cb => {
            if (cb.closest('tr').style.display !== 'none') {
                cb.checked = checkbox.checked;
            }
        });
        updateSelectionCount();
    }

    function deselectAll() {
        document.getElementById('selectAll').checked = false;
        toggleSelectAll(document.getElementById('selectAll'));
    }

    function updateSelectionCount() {
        const selected = document.querySelectorAll('.code-checkbox:checked');
        const count = selected.length;
        document.getElementById('selectedCount').innerText = count;
        document.getElementById('bulkActionBar').style.display = count > 0 ? 'flex' : 'none';
    }

    function showBulkEditModal() {
        const selected = document.querySelectorAll('.code-checkbox:checked');
        document.getElementById('bulk-selected-count-display').innerText = selected.length;
        showModal('bulkEditCodeModal');
    }

    async function handleBulkEditCode(event) {
        event.preventDefault();
        const selected = document.querySelectorAll('.code-checkbox:checked');
        const codes = Array.from(selected).map(cb => cb.value);
        const has_warranty = document.getElementById('bulk-edit-has-warranty').checked;
        const warranty_days = parseInt(document.getElementById('bulk-edit-warranty-days').value) || 30;

        try {
            const response = await fetch('/admin/codes/bulk-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codes, has_warranty, warranty_days: has_warranty ? warranty_days : null })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('批量更新成功', 'success');
                hideModal('bulkEditCodeModal');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(result.error || '批量更新失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    let currentFilter = 'all';

    function filterByStatus(status) {
        currentFilter = status;
        document.querySelectorAll('.filter-tab').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`filter-${status}`).classList.add('active');

        document.querySelectorAll('#codesTableBody tr').forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            if (status === 'all' || rowStatus === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
                const cb = row.querySelector('.code-checkbox');
                if (cb) cb.checked = false;
            }
        });
        updateSelectionCount();
    }

    async function deleteCode(code) {
        if (!confirm(`确定要删除兑换码 ${code} 吗?`)) return;
        try {
            const response = await fetch(`/admin/codes/${encodeURIComponent(code)}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('删除成功', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(result.error || '删除失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    async function exportCodes() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const search = urlParams.get('search') || '';
            const exportUrl = `/admin/codes/export${search ? '?search=' + encodeURIComponent(search) : ''}`;
            const response = await fetch(exportUrl);
            if (response.ok) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `redemption_codes_${new Date().getTime()}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('导出成功', 'success');
            } else {
                showToast('导出失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    function editCode(code, hasWarranty, warrantyDays) {
        document.getElementById('edit-code').value = code;
        document.getElementById('edit-code-display').value = code;
        const hasWarrantyCheckbox = document.getElementById('edit-has-warranty');
        hasWarrantyCheckbox.checked = hasWarranty;
        document.getElementById('edit-warranty-days').value = warrantyDays || 30;
        toggleWarrantyDays(hasWarrantyCheckbox, 'edit-warranty-days-group');
        showModal('editCodeModal');
    }

    async function handleEditCode(event) {
        event.preventDefault();
        const code = document.getElementById('edit-code').value;
        const has_warranty = document.getElementById('edit-has-warranty').checked;
        const warranty_days = parseInt(document.getElementById('edit-warranty-days').value) || 30;

        try {
            const response = await fetch(`/admin/codes/${encodeURIComponent(code)}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ has_warranty, warranty_days: has_warranty ? warranty_days : null })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('更新成功', 'success');
                hideModal('editCodeModal');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(result.error || '更新失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }
</script>
{% endblock %}
