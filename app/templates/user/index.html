<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT Team - 加入 ChatGPT Team</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/user.css') }}">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-logo">
                <i data-lucide="sparkles" style="width: 28px; height: 28px;"></i>
            </div>
            <h1>加入 ChatGPT Team</h1>
            <p class="subtitle">选择支付方式或使用兑换码，即刻开启 AI 之旅</p>
            {% if remaining_spots is not none %}
            <div class="spots-badge">
                <i data-lucide="users" style="width: 14px; height: 14px;"></i>
                剩余车位: {{ remaining_spots }}
            </div>
            {% endif %}
        </div>

        <!-- 主卡片 -->
        <div id="mainCard" class="card">
            <!-- 方式选择 -->
            <div class="method-selector">
                {% if alipay_enabled %}
                <div class="method-option alipay {% if alipay_enabled %}selected{% endif %}" data-method="alipay">
                    <span class="method-icon"><i data-lucide="smartphone" style="width: 22px; height: 22px;"></i></span>
                    <span class="method-name">支付宝</span>
                </div>
                {% endif %}
                {% if wxpay_enabled %}
                <div class="method-option wxpay {% if not alipay_enabled %}selected{% endif %}" data-method="wxpay">
                    <span class="method-icon"><i data-lucide="message-circle" style="width: 22px; height: 22px;"></i></span>
                    <span class="method-name">微信支付</span>
                </div>
                {% endif %}
                <div class="method-option redeem {% if not alipay_enabled and not wxpay_enabled %}selected{% endif %}" data-method="redeem">
                    <span class="method-icon"><i data-lucide="ticket" style="width: 22px; height: 22px;"></i></span>
                    <span class="method-name">兑换码</span>
                </div>
            </div>

            <!-- 支付表单 -->
            <div class="payment-form {% if alipay_enabled or wxpay_enabled %}active{% endif %}" id="paymentForm">
                <form id="payForm">
                    <div class="form-group">
                        <label for="payEmail">邮箱地址</label>
                        <input type="email" id="payEmail" name="email" required placeholder="请输入您的邮箱地址"
                            class="form-input">
                        <p class="form-help">邀请将发送到此邮箱，请确保填写正确</p>
                    </div>
                    <button type="submit" class="btn btn-primary" id="payBtn">
                        立即支付 ¥{{ price }}
                    </button>
                </form>
            </div>

            <!-- 兑换码表单 -->
            <div class="redeem-form {% if not alipay_enabled and not wxpay_enabled %}active{% endif %}" id="redeemForm">
                <form id="codeForm">
                    <div class="form-group">
                        <label for="redeemEmail">邮箱地址</label>
                        <input type="email" id="redeemEmail" name="email" required placeholder="请输入您的邮箱地址"
                            class="form-input">
                        <p class="form-help">邀请将发送到此邮箱</p>
                    </div>
                    <div class="form-group">
                        <label for="code">兑换码</label>
                        <input type="text" id="code" name="code" required placeholder="请输入兑换码" class="form-input">
                    </div>
                    <button type="submit" class="btn btn-primary" id="redeemBtn">
                        立即兑换
                    </button>
                </form>
            </div>
        </div>

        <!-- 质保查询卡片 -->
        <div id="warrantyCard" class="card warranty-card">
            <div class="warranty-header">
                <div class="warranty-icon">
                    <i data-lucide="shield-check" style="width: 16px; height: 16px;"></i>
                </div>
                <h3>质保查询</h3>
            </div>
            <div class="warranty-body">
                <p class="form-help">30 天质保-Team 被封后可在质保期内重新上车</p>
                <div class="inline-form">
                    <input type="text" id="warrantyInput" placeholder="输入邮箱查询" class="form-input">
                    <button type="button" class="btn btn-secondary" id="checkWarrantyBtn" onclick="checkWarranty()">
                        查询
                    </button>
                </div>
            </div>
        </div>

        <!-- 质保查询结果 -->
        <div id="warrantyResult" class="card" style="display: none; margin-top: 12px;">
            <h2>质保查询结果</h2>
            <div id="warrantyContent"></div>
            <div id="warrantyActions" style="margin-top: 20px; display: flex; gap: 10px;"></div>
        </div>

        <!-- 兑换结果 -->
        <div id="resultCard" class="card" style="display: none; margin-top: 12px;">
            <div id="resultContent"></div>
        </div>

        <!-- Footer -->
        <div class="page-footer">
            &copy; 2026 GPT Team
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        if (window.lucide) lucide.createIcons();

        const alipayEnabled = {{ 'true' if alipay_enabled else 'false' }};
        const wxpayEnabled = {{ 'true' if wxpay_enabled else 'false' }};
        let selectedMethod = alipayEnabled ? 'alipay' : (wxpayEnabled ? 'wxpay' : 'redeem');

        // 检查支付成功回调
        (function checkPaymentSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success');
            const orderNo = urlParams.get('order_no');

            if (paymentSuccess === '1') {
                window.history.replaceState({}, document.title, window.location.pathname);
                setTimeout(() => showPaymentSuccessMessage(orderNo), 100);
            }
        })();

        function showPaymentSuccessMessage(orderNo) {
            document.getElementById('mainCard').style.display = 'none';
            document.getElementById('warrantyCard').style.display = 'none';
            document.getElementById('resultCard').style.display = 'block';

            document.getElementById('resultContent').innerHTML = `
                <div class="success-result">
                    <div class="success-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    <h2>支付成功</h2>
                    <p class="success-msg">邀请已发送到您的邮箱，请查收并完成加入</p>
                    ${orderNo ? `
                    <div class="result-info-box">
                        <div class="info-row">
                            <span class="info-label">订单号</span>
                            <span class="info-value mono">${escapeHtml(orderNo)}</span>
                        </div>
                    </div>
                    ` : ''}
                    <button onclick="location.href='/'" class="btn btn-primary">返回首页</button>
                </div>
            `;
        }

        // 方式选择
        document.querySelectorAll('.method-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.method-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedMethod = option.dataset.method;

                if (selectedMethod === 'redeem') {
                    document.getElementById('paymentForm').classList.remove('active');
                    document.getElementById('redeemForm').classList.add('active');
                } else {
                    document.getElementById('paymentForm').classList.add('active');
                    document.getElementById('redeemForm').classList.remove('active');
                }
            });
        });

        // 检查库存
        async function checkStock() {
            try {
                const response = await fetch('/api/stock/check');
                const result = await response.json();
                if (!result.success) throw new Error(result.error || '库存检查失败');
                if (result.available_spots <= 0) throw new Error('暂无可用车位，请稍后再试');
                return true;
            } catch (error) {
                throw error;
            }
        }

        // 支付表单
        document.getElementById('payForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('payEmail').value;
            const payBtn = document.getElementById('payBtn');

            if (!email) { showToast('请输入邮箱地址', 'error'); return; }

            payBtn.disabled = true;
            payBtn.textContent = '检查库存中...';

            try {
                await checkStock();
                payBtn.textContent = '创建订单中...';

                const response = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, pay_type: selectedMethod })
                });

                const result = await response.json();
                if (!response.ok || !result.success) throw new Error(result.detail || result.error || '创建订单失败');
                if (result.pay_url) { window.location.href = result.pay_url; }
                else { throw new Error('未获取到支付信息'); }
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                payBtn.disabled = false;
                payBtn.textContent = '立即支付 ¥{{ price }}';
            }
        });

        // 兑换码表单
        document.getElementById('codeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('redeemEmail').value.trim();
            const code = document.getElementById('code').value.trim();
            const redeemBtn = document.getElementById('redeemBtn');

            if (!email || !code) { showToast('请填写完整信息', 'error'); return; }

            redeemBtn.disabled = true;
            redeemBtn.textContent = '兑换中...';

            try {
                const response = await fetch('/redeem/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, team_id: null })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showSuccessResult(result, email);
                } else {
                    showToast(result.detail || result.error || '兑换失败', 'error');
                }
            } catch (error) {
                showToast('兑换失败: ' + error.message, 'error');
            } finally {
                redeemBtn.disabled = false;
                redeemBtn.textContent = '立即兑换';
            }
        });

        function showSuccessResult(data, email) {
            document.getElementById('mainCard').style.display = 'none';
            document.getElementById('warrantyCard').style.display = 'none';
            document.getElementById('resultCard').style.display = 'block';

            const teamInfo = data.team_info || {};
            document.getElementById('resultContent').innerHTML = `
                <div class="success-result">
                    <div class="success-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    <h2>兑换成功</h2>
                    <p class="success-msg">${escapeHtml(data.message || '已成功加入 Team')}</p>
                    <div class="result-info-box">
                        <div class="info-row">
                            <span class="info-label">邮箱</span>
                            <span class="info-value">${escapeHtml(email)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Team</span>
                            <span class="info-value">${escapeHtml(teamInfo.team_name || '-')}</span>
                        </div>
                        ${teamInfo.expires_at ? `
                        <div class="info-row">
                            <span class="info-label">到期时间</span>
                            <span class="info-value">${formatDate(teamInfo.expires_at)}</span>
                        </div>
                        ` : ''}
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">请查收邮箱中的邀请邮件并完成加入</p>
                    <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">返回首页</button>
                </div>
            `;
        }

        // 质保查询
        async function checkWarranty() {
            const input = document.getElementById('warrantyInput').value.trim();
            if (!input) { showToast('请输入兑换码或邮箱', 'error'); return; }

            const btn = document.getElementById('checkWarrantyBtn');
            btn.disabled = true;
            btn.textContent = '查询中...';

            try {
                const response = await fetch('/warranty/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(input.includes('@') ? { email: input } : { code: input })
                });

                const result = await response.json();
                if (result.success) { showWarrantyResult(result); }
                else { showToast(result.error || '查询失败', 'error'); }
            } catch (error) {
                showToast('查询失败: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '查询';
            }
        }

        function showWarrantyResult(data) {
            document.getElementById('mainCard').style.display = 'none';
            document.getElementById('warrantyCard').style.display = 'none';
            document.getElementById('warrantyResult').style.display = 'block';

            const records = data.records || [];
            let html = '';

            let hasAfterSales = false;
            let afterSalesEmail = '';
            let afterSalesCode = '';

            if (records.length === 0) {
                html = '<p style="text-align: center; color: var(--text-secondary); padding: 32px;">未找到相关记录</p>';
            } else {
                records.forEach(record => {
                    let badgeClass = 'muted';
                    let statusText = '未知';

                    if (record.status === 'after_sales_available') {
                        badgeClass = 'success';
                        statusText = '可售后';
                        hasAfterSales = true;
                        afterSalesEmail = record.email || '';
                        afterSalesCode = record.code || '';
                    } else if (record.status === 'normal') {
                        badgeClass = 'info';
                        statusText = '正常';
                    } else if (record.status === 'expired') {
                        badgeClass = 'danger';
                        statusText = '已过期';
                    }

                    // Team 状态 badge
                    let teamBadgeClass = 'muted';
                    let teamStatusText = '未知';
                    const ts = (record.team_status || '').toLowerCase();
                    if (ts === 'active') { teamBadgeClass = 'info'; teamStatusText = '正常'; }
                    else if (ts === 'banned') { teamBadgeClass = 'danger'; teamStatusText = '已封禁'; }
                    else if (ts === 'inactive') { teamBadgeClass = 'muted'; teamStatusText = '未激活'; }
                    else if (ts === 'expired') { teamBadgeClass = 'danger'; teamStatusText = '已过期'; }
                    else if (ts === 'error') { teamBadgeClass = 'danger'; teamStatusText = '异常'; }
                    else if (record.team_status) { teamStatusText = record.team_status; }

                    html += `
                        <div class="warranty-record">
                            <p>
                                <span class="record-label">来源</span>
                                <span class="record-value">${record.source_type === 'payment' ? '支付' : record.source_type === 'after_sales' ? '售后换车' : '兑换码'}</span>
                            </p>
                            <p>
                                <span class="record-label">售后状态</span>
                                <span class="status-badge ${badgeClass}">${statusText}</span>
                            </p>
                            <p>
                                <span class="record-label">Team 状态</span>
                                <span class="status-badge ${teamBadgeClass}">${escapeHtml(teamStatusText)}</span>
                            </p>
                            ${record.status_reason ? `
                            <p style="justify-content: flex-start; color: var(--text-secondary); font-size: 0.8125rem;">
                                ${escapeHtml(record.status_reason)}
                            </p>
                            ` : ''}
                            ${record.warranty_expires_at ? `
                            <p>
                                <span class="record-label">售后到期</span>
                                <span class="record-value">${formatDate(record.warranty_expires_at)}</span>
                            </p>
                            ` : ''}
                        </div>
                    `;
                });
            }

            document.getElementById('warrantyContent').innerHTML = html;

            // 底部按钮区
            const actionsEl = document.getElementById('warrantyActions');
            if (hasAfterSales) {
                actionsEl.innerHTML = `
                    <button class="btn btn-primary" style="flex: 1;" id="reinviteBtn" onclick="reinviteAfterSales('${escapeHtml(afterSalesEmail)}', '${escapeHtml(afterSalesCode)}', this)">重新上车</button>
                    <button onclick="hideWarrantyResult()" class="btn btn-secondary" style="flex: 1;">返回</button>
                `;
            } else {
                actionsEl.innerHTML = `
                    <button onclick="hideWarrantyResult()" class="btn btn-secondary" style="flex: 1;">返回</button>
                `;
            }
        }

        async function reinviteAfterSales(email, code, btn) {
            if (!email) { showToast('缺少邮箱信息', 'error'); return; }
            if (!btn) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '处理中...';

            try {
                const response = await fetch('/warranty/reinvite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code: code || null })
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    showToast(result.detail || result.error || '操作失败', 'error');
                    return;
                }

                showToast(result.message || '重新上车成功，请查收邮箱', 'success');
                const teamInfo = result.team_info || {};
                const infoHtml = `
                    <div style="margin-top: 12px; padding: 14px 16px; border-radius: var(--radius-md); background: var(--success-soft); color: var(--text-main); border: 1px solid rgba(52, 199, 89, 0.15);">
                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.875rem;">已发送新邀请</div>
                        <div style="font-size: 0.8125rem; color: var(--text-secondary);">Team: ${escapeHtml(teamInfo.team_name || '-')}</div>
                        ${teamInfo.expires_at ? `<div style="font-size: 0.8125rem; color: var(--text-secondary);">Team 订阅到期: ${formatDate(teamInfo.expires_at)}</div>` : ''}
                        ${teamInfo.warranty_expires_at ? `<div style="font-size: 0.8125rem; color: var(--text-secondary);">质保到期: ${formatDate(teamInfo.warranty_expires_at)}</div>` : ''}
                    </div>
                `;
                const wrapper = document.getElementById('warrantyContent');
                if (wrapper) wrapper.insertAdjacentHTML('beforeend', infoHtml);
            } catch (error) {
                showToast('操作失败: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function hideWarrantyResult() {
            document.getElementById('warrantyResult').style.display = 'none';
            document.getElementById('mainCard').style.display = 'block';
            document.getElementById('warrantyCard').style.display = 'block';
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>

</html>
