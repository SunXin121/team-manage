<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT Team - åŠ å…¥ ChatGPT Team</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/user.css') }}">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .method-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }

        .method-option {
            flex: 1;
            padding: 16px 12px;
            border: 2px solid var(--border-base);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: var(--bg-primary);
        }

        .method-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .method-option.selected {
            border-color: var(--primary);
            background: var(--primary-soft);
        }

        .method-option .method-icon {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }

        .method-option.alipay .method-icon {
            color: #1677ff;
        }

        .method-option.wxpay .method-icon {
            color: #07c160;
        }

        .method-option.redeem .method-icon {
            color: var(--primary);
        }

        .method-option .method-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .method-option .method-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .payment-form,
        .redeem-form {
            display: none;
        }

        .payment-form.active,
        .redeem-form.active {
            display: block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .warranty-section {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid var(--border-base);
        }

        .warranty-section h3 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }


    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>åŠ å…¥ ChatGPT Team</h1>
            <p class="subtitle">é€‰æ‹©æ”¯ä»˜æ–¹å¼æˆ–ä½¿ç”¨å…‘æ¢ç </p>
            {% if remaining_spots is not none %}
            <div class="spots-badge"
                style="display: inline-flex; align-items: center; gap: 6px; background: var(--primary-soft); padding: 6px 12px; border-radius: 20px; font-size: 0.875rem; color: var(--primary); margin-top: 10px; border: 1px solid var(--border-base);">
                <i data-lucide="users" style="width: 14px; height: 14px;"></i> å‰©ä½™è½¦ä½: {{ remaining_spots }}
            </div>
            {% endif %}
        </div>

        <!-- ä¸»å¡ç‰‡ -->
        <div id="mainCard" class="card">
            <!-- æ–¹å¼é€‰æ‹© -->
            <div class="method-selector">
                {% if alipay_enabled %}
                <div class="method-option alipay {% if alipay_enabled %}selected{% endif %}" data-method="alipay">
                    <span class="method-icon"><i data-lucide="smartphone"></i></span>
                    <span class="method-name">æ”¯ä»˜å®</span>
                </div>
                {% endif %}
                {% if wxpay_enabled %}
                <div class="method-option wxpay {% if not alipay_enabled %}selected{% endif %}" data-method="wxpay">
                    <span class="method-icon"><i data-lucide="message-circle"></i></span>
                    <span class="method-name">å¾®ä¿¡æ”¯ä»˜</span>
                </div>
                {% endif %}
                <div class="method-option redeem {% if not alipay_enabled and not wxpay_enabled %}selected{% endif %}" data-method="redeem">
                    <span class="method-icon"><i data-lucide="ticket"></i></span>
                    <span class="method-name">å…‘æ¢ç </span>
                </div>
            </div>

            <!-- æ”¯ä»˜è¡¨å• -->
            <div class="payment-form {% if alipay_enabled or wxpay_enabled %}active{% endif %}" id="paymentForm">
                <form id="payForm">
                    <div class="form-group">
                        <label for="payEmail">é‚®ç®±åœ°å€</label>
                        <input type="email" id="payEmail" name="email" required placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€"
                            class="form-input">
                        <p class="form-help">é‚€è¯·å°†å‘é€åˆ°æ­¤é‚®ç®±ï¼Œè¯·ç¡®ä¿å¡«å†™æ­£ç¡®</p>
                    </div>

                    <button type="submit" class="btn btn-primary" id="payBtn" style="width: 100%;">
                        <i data-lucide="credit-card"></i> ç«‹å³æ”¯ä»˜ Â¥{{ price }}
                    </button>
                </form>


            </div>

            <!-- å…‘æ¢ç è¡¨å• -->
            <div class="redeem-form {% if not alipay_enabled and not wxpay_enabled %}active{% endif %}" id="redeemForm">
                <form id="codeForm">
                    <div class="form-group">
                        <label for="redeemEmail">é‚®ç®±åœ°å€</label>
                        <input type="email" id="redeemEmail" name="email" required placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€"
                            class="form-input">
                        <p class="form-help">é‚€è¯·å°†å‘é€åˆ°æ­¤é‚®ç®±</p>
                    </div>

                    <div class="form-group">
                        <label for="code">å…‘æ¢ç </label>
                        <input type="text" id="code" name="code" required placeholder="è¯·è¾“å…¥å…‘æ¢ç " class="form-input">
                    </div>

                    <button type="submit" class="btn btn-primary" id="redeemBtn" style="width: 100%;">
                        <i data-lucide="check-circle"></i> ç«‹å³å…‘æ¢
                    </button>
                </form>
            </div>
        </div>

        <!-- è´¨ä¿æŸ¥è¯¢å¡ç‰‡ (ç‹¬ç«‹æ˜¾ç¤º) -->
        <div id="warrantyCard" class="card" style="margin-top: 10px;">
            <h3 style="font-size: 1rem; margin-bottom: 12px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                <i data-lucide="shield" style="width: 18px; height: 18px;"></i>
                è´¨ä¿æŸ¥è¯¢
            </h3>
            <p class="form-help" style="margin-bottom: 12px;">
                è´¨ä¿å…‘æ¢ç åœ¨ Team è¢«å°åå¯åœ¨è´¨ä¿æœŸå†…é‡å¤ä½¿ç”¨
            </p>
            <div class="form-group" style="margin-bottom: 12px;">
                <input type="text" id="warrantyInput" placeholder="è¾“å…¥å…‘æ¢ç æˆ–é‚®ç®±æŸ¥è¯¢" class="form-input">
            </div>
            <button type="button" class="btn btn-secondary" id="checkWarrantyBtn" onclick="checkWarranty()"
                style="width: 100%;">
                <i data-lucide="search"></i> æŸ¥è¯¢è´¨ä¿çŠ¶æ€
            </button>
        </div>

        <!-- è´¨ä¿æŸ¥è¯¢ç»“æœ -->
        <div id="warrantyResult" class="card" style="display: none;">
            <h2>è´¨ä¿æŸ¥è¯¢ç»“æœ</h2>
            <div id="warrantyContent"></div>
            <div class="actions" style="margin-top: 20px;">
                <button onclick="hideWarrantyResult()" class="btn btn-secondary" style="width: 100%;">è¿”å›</button>
            </div>
        </div>

        <!-- å…‘æ¢ç»“æœ -->
        <div id="resultCard" class="card" style="display: none;">
            <div id="resultContent"></div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        // åˆå§‹åŒ– Lucide å›¾æ ‡
        if (window.lucide) lucide.createIcons();

        // æ”¯ä»˜æ–¹å¼é…ç½®
        const alipayEnabled = {{ 'true' if alipay_enabled else 'false' }};
        const wxpayEnabled = {{ 'true' if wxpay_enabled else 'false' }};

        // å…¨å±€å˜é‡ - æ ¹æ®å¯ç”¨æ”¯ä»˜æ–¹å¼è®¾ç½®é»˜è®¤å€¼
        let selectedMethod = alipayEnabled ? 'alipay' : (wxpayEnabled ? 'wxpay' : 'redeem');


        // æ£€æŸ¥URLå‚æ•°ï¼Œå¤„ç†æ”¯ä»˜æˆåŠŸè·³è½¬å›æ¥çš„æƒ…å†µ
        (function checkPaymentSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success');
            const orderNo = urlParams.get('order_no');
            
            if (paymentSuccess === '1') {
                // æ¸…é™¤URLå‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤æ˜¾ç¤º
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸæç¤º
                setTimeout(() => {
                    showPaymentSuccessMessage(orderNo);
                }, 100);
            }
        })();

        function showPaymentSuccessMessage(orderNo) {
            document.getElementById('mainCard').style.display = 'none';
            document.getElementById('warrantyCard').style.display = 'none';
            document.getElementById('resultCard').style.display = 'block';

            document.getElementById('resultContent').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="width: 80px; height: 80px; background: #d4edda; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px; color: #28a745;">âœ“</div>
                    <h2 style="color: #28a745; margin-bottom: 10px;">æ”¯ä»˜æˆåŠŸï¼</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 25px;">é‚€è¯·å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶å¹¶å®ŒæˆåŠ å…¥</p>
                    ${orderNo ? `
                    <div style="background: var(--bg-secondary); border-radius: 10px; padding: 20px; text-align: left; margin-bottom: 20px;">
                        <p style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span style="color: var(--text-secondary);">è®¢å•å·</span><span style="font-family: monospace; font-size: 0.85rem;">${escapeHtml(orderNo)}</span></p>
                    </div>
                    ` : ''}
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">ğŸ“§ è¯·æŸ¥æ”¶é‚®ç®±ä¸­çš„é‚€è¯·é‚®ä»¶å¹¶å®ŒæˆåŠ å…¥</p>
                    <button onclick="location.href='/'" class="btn btn-primary" style="margin-top: 20px; width: 100%;">è¿”å›é¦–é¡µ</button>
                </div>
            `;
        }

        // æ–¹å¼é€‰æ‹©
        document.querySelectorAll('.method-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.method-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedMethod = option.dataset.method;

                // åˆ‡æ¢è¡¨å•æ˜¾ç¤º
                if (selectedMethod === 'redeem') {
                    document.getElementById('paymentForm').classList.remove('active');
                    document.getElementById('redeemForm').classList.add('active');
                } else {
                    document.getElementById('paymentForm').classList.add('active');
                    document.getElementById('redeemForm').classList.remove('active');
                }

            });
        });

        // æ£€æŸ¥åº“å­˜
        async function checkStock() {
            try {
                const response = await fetch('/api/stock/check');
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'åº“å­˜æ£€æŸ¥å¤±è´¥');
                }
                if (result.available_spots <= 0) {
                    throw new Error('æš‚æ— å¯ç”¨è½¦ä½ï¼Œè¯·ç¨åå†è¯•');
                }
                return true;
            } catch (error) {
                throw error;
            }
        }

        // æ”¯ä»˜è¡¨å•æäº¤
        document.getElementById('payForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('payEmail').value;
            const payBtn = document.getElementById('payBtn');

            if (!email) {
                showToast('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                return;
            }

            payBtn.disabled = true;
            payBtn.innerHTML = '<span class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>æ£€æŸ¥åº“å­˜ä¸­...';

            try {
                // å…ˆæ£€æŸ¥åº“å­˜
                await checkStock();

                payBtn.innerHTML = '<span class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>åˆ›å»ºè®¢å•ä¸­...';

                const response = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        pay_type: selectedMethod
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.detail || result.error || 'åˆ›å»ºè®¢å•å¤±è´¥');
                }

                if (result.pay_url) {
                    // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢ï¼Œæ”¯ä»˜å®Œæˆåç”±æ”¯ä»˜å¹³å°å›è°ƒå¤„ç†ä¸šåŠ¡é€»è¾‘
                    window.location.href = result.pay_url;
                } else {
                    throw new Error('æœªè·å–åˆ°æ”¯ä»˜ä¿¡æ¯');
                }

            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                payBtn.disabled = false;
                payBtn.innerHTML = '<i data-lucide="credit-card"></i> ç«‹å³æ”¯ä»˜ Â¥{{ price }}';
                lucide.createIcons();
            }
        });

        // å…‘æ¢ç è¡¨å•æäº¤
        document.getElementById('codeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('redeemEmail').value.trim();
            const code = document.getElementById('code').value.trim();
            const redeemBtn = document.getElementById('redeemBtn');

            if (!email || !code) {
                showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            redeemBtn.disabled = true;
            redeemBtn.innerHTML = '<span class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>å…‘æ¢ä¸­...';

            try {
                const response = await fetch('/redeem/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        code: code,
                        team_id: null
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showSuccessResult(result, email);
                } else {
                    const errorMsg = result.detail || result.error || 'å…‘æ¢å¤±è´¥';
                    showToast(errorMsg, 'error');
                }

            } catch (error) {
                showToast('å…‘æ¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                redeemBtn.disabled = false;
                redeemBtn.innerHTML = '<i data-lucide="check-circle"></i> ç«‹å³å…‘æ¢';
                lucide.createIcons();
            }
        });

        function showSuccessResult(data, email) {
            document.getElementById('mainCard').style.display = 'none';
            document.getElementById('warrantyCard').style.display = 'none';
            document.getElementById('resultCard').style.display = 'block';

            const teamInfo = data.team_info || {};
            document.getElementById('resultContent').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="width: 80px; height: 80px; background: #d4edda; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px; color: #28a745;">âœ“</div>
                    <h2 style="color: #28a745; margin-bottom: 10px;">å…‘æ¢æˆåŠŸï¼</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 25px;">${escapeHtml(data.message || 'å·²æˆåŠŸåŠ å…¥ Team')}</p>
                    <div style="background: var(--bg-secondary); border-radius: 10px; padding: 20px; text-align: left; margin-bottom: 20px;">
                        <p style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span style="color: var(--text-secondary);">é‚®ç®±</span><span>${escapeHtml(email)}</span></p>
                        <p style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span style="color: var(--text-secondary);">Team</span><span>${escapeHtml(teamInfo.team_name || '-')}</span></p>
                        ${teamInfo.expires_at ? `<p style="display: flex; justify-content: space-between;"><span style="color: var(--text-secondary);">åˆ°æœŸæ—¶é—´</span><span>${formatDate(teamInfo.expires_at)}</span></p>` : ''}
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">ğŸ“§ è¯·æŸ¥æ”¶é‚®ç®±ä¸­çš„é‚€è¯·é‚®ä»¶å¹¶å®ŒæˆåŠ å…¥</p>
                    <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px; width: 100%;">è¿”å›é¦–é¡µ</button>
                </div>
            `;
        }

        // è´¨ä¿æŸ¥è¯¢
        async function checkWarranty() {
            const input = document.getElementById('warrantyInput').value.trim();
            if (!input) {
                showToast('è¯·è¾“å…¥å…‘æ¢ç æˆ–é‚®ç®±', 'error');
                return;
            }

            const btn = document.getElementById('checkWarrantyBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border-base); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>æŸ¥è¯¢ä¸­...';

            try {
                const response = await fetch('/warranty/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(input.includes('@') ? { email: input } : { code: input })
                });

                const result = await response.json();

                if (result.success) {
                    showWarrantyResult(result);
                } else {
                    showToast(result.error || 'æŸ¥è¯¢å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="search"></i> æŸ¥è¯¢è´¨ä¿çŠ¶æ€';
                lucide.createIcons();
            }
        }

        function showWarrantyResult(data) {
            document.getElementById('mainCard').style.display = 'none';
            document.getElementById('warrantyCard').style.display = 'none';
            document.getElementById('warrantyResult').style.display = 'block';

            const records = data.records || [];
            let html = '';

            if (records.length === 0) {
                html = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">æœªæ‰¾åˆ°ç›¸å…³è®°å½•</p>';
            } else {
                records.forEach(record => {
                    let statusColor = '#6b7280';
                    let statusText = 'çŠ¶æ€æœªçŸ¥';

                    if (record.status === 'after_sales_available') {
                        statusColor = '#28a745';
                        statusText = 'å¯å”®å';
                    } else if (record.status === 'normal') {
                        statusColor = '#1677ff';
                        statusText = 'çŠ¶æ€æ­£å¸¸';
                    } else if (record.status === 'expired') {
                        statusColor = '#dc3545';
                        statusText = 'å”®åè¿‡æœŸ';
                    }

                    html += `
                        <div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                            <p style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">æ¥æºç±»å‹</span>
                                <span>${record.source_type === 'payment' ? 'æ”¯ä»˜é‚€è¯·' : 'å…‘æ¢ç é‚€è¯·'}</span>
                            </p>
                            <p style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">æ ‡è¯†</span>
                                <code style="font-size: 0.85rem;">${escapeHtml(record.code || '-')}</code>
                            </p>
                            <p style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">çŠ¶æ€</span>
                                <span style="color: ${statusColor}; font-weight: 500;">${statusText}</span>
                            </p>
                            <p style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">Team çŠ¶æ€</span>
                                <span>${escapeHtml(record.team_status || '-')}</span>
                            </p>
                            ${record.status_reason ? `
                            <p style="margin-bottom: 8px; color: var(--text-secondary);">
                                ${escapeHtml(record.status_reason)}
                            </p>
                            ` : ''}
                            ${record.warranty_expires_at ? `
                            <p style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">å”®ååˆ°æœŸ</span>
                                <span>${formatDate(record.warranty_expires_at)}</span>
                            </p>
                            ` : ''}
                            ${record.status === 'after_sales_available' ? `
                            <div style="margin-top: 12px;">
                                <button class="btn btn-primary" style="width: 100%;" onclick="reinviteAfterSales('${escapeHtml(record.email || '')}', '${escapeHtml(record.code || '')}', this)">
                                    ç«‹å³å”®åé‡é‚€
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            document.getElementById('warrantyContent').innerHTML = html;
        }

        async function reinviteAfterSales(email, code, btn) {
            if (!email) {
                showToast('ç¼ºå°‘é‚®ç®±ä¿¡æ¯ï¼Œæ— æ³•å”®åé‡é‚€', 'error');
                return;
            }

            if (!btn) return;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'å¤„ç†ä¸­...';

            try {
                const response = await fetch('/warranty/reinvite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code: code || null })
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    showToast(result.detail || result.error || 'å”®åé‡é‚€å¤±è´¥', 'error');
                    return;
                }

                showToast(result.message || 'å”®åé‡é‚€æˆåŠŸï¼Œè¯·æŸ¥æ”¶é‚®ç®±', 'success');

                const teamInfo = result.team_info || {};
                const infoHtml = `
                    <div style="margin-top: 12px; padding: 12px; border-radius: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.25); color: var(--text-primary);">
                        <div style="font-weight: 600; margin-bottom: 6px;">å·²å‘é€æ–° Team é‚€è¯·</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Team: ${escapeHtml(teamInfo.team_name || '-')}</div>
                        ${teamInfo.expires_at ? `<div style="font-size: 0.9rem; color: var(--text-secondary);">åˆ°æœŸ: ${formatDate(teamInfo.expires_at)}</div>` : ''}
                    </div>
                `;

                const wrapper = btn.closest('div[style*="background: var(--bg-secondary)"]') || btn.parentElement;
                if (wrapper) {
                    wrapper.insertAdjacentHTML('beforeend', infoHtml);
                }
            } catch (error) {
                showToast('å”®åé‡é‚€å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function hideWarrantyResult() {
            document.getElementById('warrantyResult').style.display = 'none';
            document.getElementById('mainCard').style.display = 'block';
            document.getElementById('warrantyCard').style.display = 'block';
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>

</html>
